CREATE DATABASE Buoi2_BTTH_Bai8

USE Buoi2_BTTH_Bai8

-- Tạo bảng KHACHHANG
CREATE TABLE KHACHHANG (
    MAKH VARCHAR(10) PRIMARY KEY,
    TENKH NVARCHAR(50),
    DCHI NVARCHAR(50),
    DTHOAI NVARCHAR(15)
);

-- Tạo bảng NHASX
CREATE TABLE NHASX (
    MANSX VARCHAR(10) PRIMARY KEY,
    TENNSX NVARCHAR(50),
    DCHI NVARCHAR(50),
    DTHOAI NVARCHAR(50)
);

-- Tạo bảng NHACC
CREATE TABLE NHACC (
    MANCC VARCHAR(10) PRIMARY KEY,
    TENNCC NVARCHAR(50),
    DCHI NVARCHAR(50),
    DTHOAI NVARCHAR(15)
);

-- Tạo bảng PHIEUNHAP
CREATE TABLE PHIEUNHAP (
    MAPN VARCHAR(10) PRIMARY KEY,
    NGAYNHAP DATE,
    MANCC VARCHAR(10),
    TIENNHAP INT,
    CONSTRAINT FK_PHIEUNHAP_NHACC FOREIGN KEY (MANCC) REFERENCES NHACC(MANCC)
);

-- Tạo bảng HANG
CREATE TABLE HANG (
    MAHG VARCHAR(10) PRIMARY KEY,
    TENHG NVARCHAR(50),
    DVT NVARCHAR(50),
    SOLUONG INT,
    MANSX VARCHAR(10),
    TINHTRANG NVARCHAR(50),
    CONSTRAINT FK_HANG_NHASX FOREIGN KEY (MANSX) REFERENCES NHASX(MANSX)
);

-- Tạo bảng CHITIETPN
CREATE TABLE CHITIETPN (
    MAPN VARCHAR(10),
    MAHG VARCHAR(10),
    SOLUONG INT,
    GIANHAP INT,
    THANHTIEN INT,
    PRIMARY KEY (MAPN, MAHG),
    CONSTRAINT FK_CHITIETPN_PHIEUNHAP FOREIGN KEY (MAPN) REFERENCES PHIEUNHAP(MAPN),
    CONSTRAINT FK_CHITIETPN_HANG FOREIGN KEY (MAHG) REFERENCES HANG(MAHG)
);

-- Tạo bảng HOADON
CREATE TABLE HOADON (
    MAHD VARCHAR(10) PRIMARY KEY,
    NGAYBAN DATE,
    TENNV NVARCHAR(50),
    MAKH VARCHAR(10),
    TIENBAN INT,
    GIAMGIA INT,
    THANHTOAN INT,
    CONSTRAINT FK_HOADON_KHACHHANG FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)
);

-- Tạo bảng CHITIETHD
CREATE TABLE CHITIETHD (
    MAHD VARCHAR(10),
    MAHG VARCHAR(10),
    SOLUONG INT,
    GIABAN INT,
    THANHTIEN INT,
    PRIMARY KEY (MAHD, MAHG),
    CONSTRAINT FK_CHITIETHD_HOADON FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD),
    CONSTRAINT FK_CHITIETHD_HANG FOREIGN KEY (MAHG) REFERENCES HANG(MAHG)
);

-- Tạo bảng DONGIA
CREATE TABLE DONGIA (
    MAHG VARCHAR(10) PRIMARY KEY,
    NGAYCN DATE,
    GIA INT,
    CONSTRAINT FK_DONGIA_HANG FOREIGN KEY (MAHG) REFERENCES HANG(MAHG)
);
------------------------TRIGGER--------------------------------------|
--a/ Trigger cập nhật THANHTIEN, TIENNHAP và TIENBAN
-- Trigger cho bảng CHITIETPN
CREATE TRIGGER tr_CHITIETPN_AfterInsert
ON CHITIETPN
AFTER INSERT
AS
BEGIN
    -- Cập nhật THANHTIEN trong bảng CHITIETPN
    UPDATE CHITIETPN
    SET THANHTIEN = inserted.SOLUONG * inserted.GIANHAP
    FROM CHITIETPN
    INNER JOIN inserted ON CHITIETPN.MAPN = inserted.MAPN AND CHITIETPN.MAHG = inserted.MAHG;

    -- Cập nhật TIENNHAP trong bảng PHIEUNHAP
    UPDATE PHIEUNHAP
    SET TIENNHAP = (SELECT SUM(THANHTIEN) FROM CHITIETPN WHERE MAPN = PHIEUNHAP.MAPN)
    FROM PHIEUNHAP
    INNER JOIN inserted ON PHIEUNHAP.MAPN = inserted.MAPN;
END;
GO

-- Trigger cho bảng CHITIETHD
CREATE TRIGGER tr_CHITIETHD_AfterInsert
ON CHITIETHD
AFTER INSERT
AS
BEGIN
    -- Cập nhật THANHTIEN trong bảng CHITIETHD
    UPDATE CHITIETHD
    SET THANHTIEN = inserted.SOLUONG * inserted.GIABAN
    FROM CHITIETHD
    INNER JOIN inserted ON CHITIETHD.MAHD = inserted.MAHD AND CHITIETHD.MAHG = inserted.MAHG;

    -- Cập nhật TIENBAN trong bảng HOADON
    UPDATE HOADON
    SET TIENBAN = (SELECT SUM(THANHTIEN) FROM CHITIETHD WHERE MAHD = HOADON.MAHD)
    FROM HOADON
    INNER JOIN inserted ON HOADON.MAHD = inserted.MAHD;
END;
GO
DROP Trigger tr_CHITIETHD_AfterInsert
--b/ Trigger cập nhật TINHTRANG trên bảng HANG
-- Trigger cho bảng CHITIETHD
CREATE TRIGGER tr_CHITIETHD_AfterInsert
ON CHITIETHD
AFTER INSERT
AS
BEGIN
    -- Cập nhật TINHTRANG trong bảng HANG
    UPDATE HANG
    SET TINHTRANG = 
        CASE
            WHEN HANG.SOLUONG = 0 THEN N'Hết hàng'
            WHEN HANG.SOLUONG - inserted.SOLUONG < 0 THEN N'Không đủ hàng bán'
            ELSE 'Đã bán'
        END
    FROM HANG
    INNER JOIN inserted ON HANG.MAHG = inserted.MAHG;

    -- Kiểm tra và hiển thị thông báo nếu có lỗi
    IF EXISTS (SELECT 1 FROM HANG WHERE TINHTRANG = N'Không đủ hàng bán')
    BEGIN
        PRINT N'Không đủ hàng bán';
    END
END;
GO


--c/ Trigger tăng SOLUONG trên bảng HANG khi nhập hàng
CREATE TRIGGER TangSoLuong_Hang
ON CHITIETPN
AFTER INSERT
AS
BEGIN
    DECLARE @MaHang VARCHAR(10);
    DECLARE @SoLuongNhap INT;

    SELECT @MaHang = MAHG, @SoLuongNhap = SOLUONG
    FROM inserted;

    UPDATE HANG
    SET SOLUONG = SOLUONG + @SoLuongNhap
    WHERE MAHG = @MaHang;
END;
--d/ Trigger giảm SOLUONG trên bảng HANG khi bán hàng
CREATE TRIGGER GiamSoLuong_Hang
ON CHITIETHD
AFTER INSERT
AS
BEGIN
    DECLARE @MaHang VARCHAR(10);
    DECLARE @SoLuongBan INT;

    SELECT @MaHang = MAHG, @SoLuongBan = SOLUONG
    FROM inserted;

    UPDATE HANG
    SET SOLUONG = SOLUONG - @SoLuongBan
    WHERE MAHG = @MaHang;
END;
--e/ Trigger cập nhật NGAYNHAP trên bảng PHIEUNHAP
CREATE TRIGGER UpdateNgayNhap_PhieuNhap
ON PHIEUNHAP
AFTER INSERT
AS
BEGIN
    UPDATE PHIEUNHAP
    SET NGAYNHAP = GETDATE()
    FROM PHIEUNHAP
    INNER JOIN inserted ON PHIEUNHAP.MAPN = inserted.MAPN;
END;
--f/ Trigger cập nhật NGAYBAN trên bảng HOADON
CREATE TRIGGER UpdateNgayBan_HoaDon
ON HOADON
AFTER INSERT
AS
BEGIN
    UPDATE HOADON
    SET NGAYBAN = GETDATE()
    FROM HOADON
    INNER JOIN inserted ON HOADON.MAHD = inserted.MAHD;
END;

--g/ Trigger cập nhật GIABAN trên bảng CHITIETHD
-- Trigger cho bảng CHITIETHD
CREATE TRIGGER tr_CHITIETHD_GiaBan
ON CHITIETHD
AFTER INSERT
AS
BEGIN
    -- Cập nhật GIABAN trong bảng CHITIETHD
    UPDATE CHITIETHD
    SET GIABAN = DONGIA.GIA
    FROM CHITIETHD
    INNER JOIN DONGIA ON CHITIETHD.MAHG = DONGIA.MAHG
    WHERE CHITIETHD.MAHG = DONGIA.MAHG
    AND DONGIA.NGAYCN = (SELECT MAX(NGAYCN) FROM DONGIA WHERE MAHG = CHITIETHD.MAHG);

END;
GO



--h/ Trigger cập nhật giảm giá và thanh toán trên bảng HOADON
CREATE TRIGGER UpdateGiamGia_ThanhToan_HoaDon
ON HOADON
AFTER INSERT
AS
BEGIN
    -- Cập nhật cột GIAMGIA và THANHTOAN trong bảng HOADON
    UPDATE HOADON
    SET GIAMGIA = 
        CASE
            WHEN TIENBAN >= 500000 THEN '10%'
            WHEN TIENBAN >= 200000 THEN '5%'
            ELSE '0%'
        END,
        THANHTOAN = TIENBAN - TIENBAN * CASE
            WHEN TIENBAN >= 500000 THEN 0.1
            WHEN TIENBAN >= 200000 THEN 0.05
            ELSE 0
        END
    FROM HOADON
    INNER JOIN inserted ON HOADON.MAHD = inserted.MAHD;

END;
GO

-------------------------Nhập liệu--------------------------------
INSERT INTO KHACHHANG (MAKH, TENKH, DCHI, DTHOAI) VALUES
('KH001', N'Nguyễn Văn A', N'123 ABC, Quận 1, TP.Hồ Chí Minh', '0795123456'),
('KH002', N'Trần Thị B', N'456 XYZ, Quận 9, TP.Hồ Chí Minh', '0769123456'),
('KH003', N'Lê Văn C', N'789 LMN, Quận 7, TP.Hồ Chí Minh', '0795123456'),
('KH004', N'Phạm Thị D', N'987 PQR, Quận Bình Thủy, Cần Thơ', '0769123456'),
('KH005', N'Hoàng Văn E', N'543 GHI, Quận Sơn Trà, Đà Nẵng', '0795123456');

INSERT INTO NHASX (MANSX, TENNSX, DCHI, DTHOAI) VALUES
('NSX001', N'Nhà Sản Xuất A', N'1234 ABC, Quận 1, TP.Hồ Chí Minh', '0795123456'),
('NSX002', N'Nhà Sản Xuất B', N'5678 XYZ, Quận 9, TP.Hồ Chí Minh', '0769123456'),
('NSX003', N'Nhà Sản Xuất C', N'4321 LMN, Quận 7, TP.Hồ Chí Minh', '0795123456');

INSERT INTO NHACC (MANCC, TENNCC, DCHI, DTHOAI) VALUES
('NCC001', N'NCC A', N'123 ABC, Quận 1, TP.Hồ Chí Minh', '0795123456'),
('NCC002', N'NCC B', N'456 XYZ, Quận 9, TP.Hồ Chí Minh', '0769123456'),
('NCC003', N'NCC C', N'789 LMN, Quận 7, TP.Hồ Chí Minh', '0795123456');
INSERT INTO PHIEUNHAP (MAPN, NGAYNHAP, MANCC, TIENNHAP) VALUES
('PN001', NULL, 'NCC001', NULL),
('PN002', NULL, 'NCC002', NULL),
('PN003', NULL, 'NCC003', NULL),
('PN004', NULL, 'NCC001', NULL),
('PN005', NULL, 'NCC002', NULL);
delete from HANG
INSERT INTO HANG (MAHG, TENHG, DVT, SOLUONG, MANSX, TINHTRANG) VALUES
('HG001', N'Hàng A', N'Cái', NULL, 'NSX001', NULL),
('HG002', N'Hàng B', N'Cái', NULL, 'NSX002', NULL),
('HG003', N'Hàng C', N'Chiếc', NULL, 'NSX001', NULL),
('HG004', N'Hàng D', N'Chiếc', NULL, 'NSX002', NULL),
('HG005', N'Hàng E', N'Chiếc', NULL, 'NSX003', NULL);
SELECT * FROM PHIEUNHAP
select * from HANG
INSERT INTO CHITIETPN (MAPN, MAHG, SOLUONG, GIANHAP, THANHTIEN) VALUES
-- Phiếu nhập 1
('PN001', 'HG001', 3, 200000, 600000),
('PN001', 'HG002', 2, 250000, 500000),
('PN001', 'HG003', 5, 180000, 900000),
('PN001', 'HG004', 4, 220000, 880000),
('PN001', 'HG005', 6, 150000, 900000),
-- Phiếu nhập 2
('PN002', 'HG001', 4, 200000, 800000),
('PN002', 'HG002', 3, 250000, 750000),
('PN002', 'HG003', 2, 180000, 360000),
('PN002', 'HG004', 5, 220000, 1100000),
('PN002', 'HG005', 6, 150000, 900000),

-- Phiếu nhập 3
('PN003', 'HG001', 2, 200000, 400000),
('PN003', 'HG002', 3, 250000, 750000),
('PN003', 'HG003', 4, 180000, 720000),
('PN003', 'HG004', 5, 220000, 1100000),
('PN003', 'HG005', 6, 150000, 900000),

-- Phiếu nhập 4
('PN004', 'HG001', 5, 200000, 1000000),
('PN004', 'HG002', 3, 250000, 750000),
('PN004', 'HG003', 2, 180000, 360000),
('PN004', 'HG004', 4, 220000, 880000),
('PN004', 'HG005', 6, 150000, 900000),

-- Phiếu nhập 5
('PN005', 'HG001', 3, 200000, 600000),
('PN005', 'HG002', 4, 250000, 1000000),
('PN005', 'HG003', 2, 180000, 360000),
('PN005', 'HG004', 5, 220000, 1100000),
('PN005', 'HG005', 6, 150000, 900000);

INSERT INTO HOADON (MAHD, NGAYBAN, TENNV, MAKH, TIENBAN, GIAMGIA, THANHTOAN) VALUES
('HD001', GETDATE(), N'Nhân Viên A', 'KH001', 500000, 0, 500000),
('HD002', GETDATE(), N'Nhân Viên B', 'KH002', 800000, 0, 800000),
('HD003', GETDATE(), N'Nhân Viên C', 'KH003', 1200000, 0, 1200000),
('HD004', GETDATE(), N'Nhân Viên A', 'KH004', 700000, 0, 700000),
('HD005', GETDATE(), N'Nhân Viên B', 'KH005', 900000, 0, 900000);

-- Chèn dữ liệu vào bảng CHITIETHD
INSERT INTO CHITIETHD (MAHD, MAHG, SOLUONG, GIABAN, THANHTIEN) VALUES
('HD001', 'HG001', 2, 250000, 500000),
('HD001', 'HG002', 3, 180000, 540000),
('HD002', 'HG003', 2, 200000, 400000),
('HD002', 'HG004', 4, 180000, 720000),
('HD003', 'HG005', 3, 200000, 600000),
('HD004', 'HG001', 4, 250000, 1000000),
('HD004', 'HG002', 3, 180000, 540000),
('HD004', 'HG003', 2, 200000, 400000),
('HD005', 'HG004', 5, 220000, 1100000),
('HD005', 'HG005', 6, 150000, 900000);

-- Chèn dữ liệu vào bảng DONGIA
INSERT INTO DONGIA (MAHG, NGAYCN, GIA) VALUES
('HG001', GETDATE(), 200000),
('HG002', GETDATE(), 250000),
('HG003', GETDATE(), 180000),
('HG004', GETDATE(), 220000),
('HG005', GETDATE(), 150000);

SELECT * FROM KHACHHANG;
SELECT * FROM NHACC;
SELECT * FROM NHASX;
SELECT * FROM PHIEUNHAP;
SELECT * FROM HANG;
SELECT * FROM CHITIETPN;
SELECT * FROM HOADON;
SELECT * FROM CHITIETHD;
SELECT * FROM DONGIA;
