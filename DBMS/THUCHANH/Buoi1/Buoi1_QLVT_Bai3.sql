CREATE DATABASE Buoi1_QLVT_Bai3 ON PRIMARY
(
    NAME = DB_PRIMARY,
    FILENAME = 'D:\VIsual Studio Code - Github\DBMS\THUCHANH\Buoi1\Bai3_QLVT\db_primary.mdf',
    SIZE = 50MB, 
    MAXSIZE = UNLIMITED,
    FILEGROWTH = 10MB 
),
(
    NAME = DB_SECOND1_1,
    FILENAME = 'D:\VIsual Studio Code - Github\DBMS\THUCHANH\Buoi1\Bai3_QLVT\DB_second1_1.ndf',
    SIZE = 50MB,
    MAXSIZE = 500MB,
    FILEGROWTH = 20MB 
),
(
    NAME = DB_SECOND1_2,
    FILENAME = 'D:\VIsual Studio Code - Github\DBMS\THUCHANH\Buoi1\Bai3_QLVT\DB_second1_2.ndf',
    SIZE = 50MB,
    MAXSIZE = 500MB,
    FILEGROWTH = 20MB 
),
(
    NAME = DB_SECOND1_3,
    FILENAME = 'D:\VIsual Studio Code - Github\DBMS\THUCHANH\Buoi1\Bai3_QLVT\DB_second1_3.ndf',
    SIZE = 50MB,
    MAXSIZE = 500MB,
    FILEGROWTH = 20MB 
)
LOG ON
(
    NAME = DB_Log,
    FILENAME = 'D:\VIsual Studio Code - Github\DBMS\THUCHANH\Buoi1\Bai3_QLVT\DB_Log.ldf',
    SIZE = 100MB,
    MAXSIZE = 500MB,
    FILEGROWTH = 50MB 
);
USE Buoi1_QLVT_Bai3

CREATE TABLE NHANVIEN
(
    MANV INT PRIMARY KEY,
    HO VARCHAR(40) NOT NULL,
    TEN VARCHAR(10) NOT NULL,
    PHAI VARCHAR(3) DEFAULT 'Nam' CHECK (PHAI IN ('Nam', 'Nu')),
    DIACHI VARCHAR(50) NOT NULL DEFAULT ' ',
    NGAYSINH DATE,
    LUONG REAL CHECK (LUONG >= 800000 AND LUONG <= 6000000) DEFAULT 800000,
    GHICHU VARCHAR(80)
);

CREATE TABLE KHO
(
    MAKHO CHAR(2) PRIMARY KEY,
    TENKHO VARCHAR(30) UNIQUE,
    DIACHI VARCHAR(70) NOT NULL
);

CREATE TABLE VATTU
(
    MAVT CHAR(4) PRIMARY KEY,
    TENVT VARCHAR(30) UNIQUE,
    DVT VARCHAR(15) DEFAULT ' '
);

CREATE TABLE PHATSINH
(
    PHIEU CHAR(8) PRIMARY KEY,
    NGAY DATE DEFAULT GETDATE(),
    LOAI CHAR CHECK (LOAI IN ('N', 'X', 'T', 'C')) DEFAULT 'N',
    HOTEN_KH VARCHAR(40) DEFAULT ' ',
    THANHTIEN REAL DEFAULT 0,
    MANV INT,
    LYDO VARCHAR(30)
);

CREATE TABLE CT_PHATSINH
(
    PHIEU CHAR(8),
    MAVT CHAR(4),
    SOLUONG INT CHECK (SOLUONG > 0),
    DONGIA REAL CHECK (DONGIA > 0),
    MAKHO CHAR(2),
    PRIMARY KEY (PHIEU, MAVT),
	CONSTRAINT FK_CTPHATSINH_PHATSINH FOREIGN KEY (PHIEU) REFERENCES PHATSINH(PHIEU),
	CONSTRAINT FK_CTPHATSINH_VATTU FOREIGN KEY (MAVT) REFERENCES VATTU(MAVT),
	CONSTRAINT FK_CTPHATSINH_KHO FOREIGN KEY (MAKHO) REFERENCES KHO(MAKHO)
);

--Truy Váº¥n
--a
SELECT * FROM NHANVIEN WHERE DATEDIFF(YEAR, NGAYSINH, GETDATE()) >= 25;
--b
SELECT PHAI, COUNT(*) AS SoLuong FROM NHANVIEN GROUP BY PHAI;
--c
SELECT * FROM NHANVIEN WHERE LUONG = (SELECT MAX(LUONG) FROM NHANVIEN);
--d
SELECT * FROM VATTU
WHERE MAVT IN (SELECT DISTINCT MAVT FROM CT_PHATSINH);
--e
UPDATE PHATSINH
SET THANHTIEN = (SELECT SUM(SOLUONG * DONGIA) FROM CT_PHATSINH WHERE CT_PHATSINH.PHIEU = PHATSINH.PHIEU);

INSERT INTO NHANVIEN (MANV, HO, TEN, PHAI, DIACHI, NGAYSINH, LUONG, GHICHU)
VALUES 
		(1, 'Nguyen', 'Van A', 'Nam', 'Ha Noi', '1990-01-15', 5000000, 'Ghi chu 1'),
		(2, 'Tran', 'Thi B', 'Nu', 'Ho Chi Minh', '1988-03-20', 900000, 'Ghi chu 2'),
		(3, 'Le', 'Van C', 'Nam', 'Da Nang', '1995-08-10', 4000000, 'Ghi chu 3');

INSERT INTO KHO (MAKHO, TENKHO, DIACHI)
VALUES 
('K1', 'Kho A', 'Ha Noi'),
('K2', 'Kho B', 'Ho Chi Minh'),
('K3', 'Kho C', 'Da Nang');
INSERT INTO VATTU (MAVT, TENVT, DVT)
VALUES 
('VT1', 'Xeng', 'Chiec'),
('VT2', 'Gach', 'Hop'),
('VT3', 'Xi Mang', 'Bao');

INSERT INTO PHATSINH (PHIEU, LOAI, HOTEN_KH, MANV, LYDO)
VALUES 
('P1', 'N', 'Khach Hang A', 1, 'Ly do 1'),
('P2', 'X', 'Khach Hang B', 2, 'Ly do 2'),
('P3', 'T', 'Khach Hang C', 3, 'Ly do 3');

INSERT INTO CT_PHATSINH (PHIEU, MAVT, SOLUONG, DONGIA, MAKHO)
VALUES 
('P1', 'VT1', 10, 5000, 'K1'),
('P2', 'VT2', 5, 8000, 'K2'),
('P3', 'VT3', 8, 6000, 'K3');
