
CREATE DATABASE QLSV_DB
ON PRIMARY
    (NAME = DB_primary,
    FILENAME = 'D:\DATABASE\BUOI4\BAITAPVENHA\DB_primary.mdf',
    SIZE = 3MB,
    MAXSIZE = 5MB,
    FILEGROWTH = 10%),
FILEGROUP QLSV_Log
    (NAME = DB_Log,
    FILENAME = 'D:\DATABASE\BUOI4\BAITAPVENHA\DB_Log.ldf',
    SIZE = 3MB,
    MAXSIZE = 10MB,
    FILEGROWTH = 15%);

USE QLSV_DB;

-- Yêu cầu 2: Tạo bảng và các ràng buộc
CREATE TABLE KHOA (
    MAKHOA NVARCHAR(10) PRIMARY KEY,
    TENKHOA NVARCHAR(30)
);

CREATE TABLE LOP (
    MALOP NVARCHAR(10) PRIMARY KEY,
    TENLOP NVARCHAR(30),
    SISODK INT,
    MAKHOA NVARCHAR(10) REFERENCES KHOA(MAKHOA)
);

CREATE TABLE SINHVIEN (
    MASV NVARCHAR(10) PRIMARY KEY,
    HOTEN NVARCHAR(30),
    NGSINH DATE,
    DCHI NVARCHAR(100),
    GIOITINH NVARCHAR(5),
    MALOP NVARCHAR(10) REFERENCES LOP(MALOP)
);

CREATE TABLE MONHOC (
    MAMH NVARCHAR(10) PRIMARY KEY,
    TENMH NVARCHAR(30),
    SOTIET INT
);

CREATE TABLE KETQUA (
    MASV NVARCHAR(10) REFERENCES SINHVIEN(MASV),
    MAMH NVARCHAR(10) REFERENCES MONHOC(MAMH),
    DIEM FLOAT,
    PRIMARY KEY (MASV, MAMH)
);

-- Thêm dữ liệu vào bảng KHOA
INSERT INTO KHOA (MAKHOA, TENKHOA) VALUES
(N'CNTT', N'Công nghệ thông tin'),
(N'KT', N'Kỹ thuật'),
(N'NN', N'Ngoại ngữ');

-- Thêm dữ liệu vào bảng LOP
INSERT INTO LOP (MALOP, TENLOP, SISODK, MAKHOA) VALUES
(N'24THTH2', N'Lớp 24THTH2', 30, N'CNTT'),
(N'25KT1', N'Lớp 25KT1', 25, N'KT'),
(N'26NN1', N'Lớp 26NN1', 20, N'NN');

-- Thêm dữ liệu vào bảng SINHVIEN
INSERT INTO SINHVIEN (MASV, HOTEN, NGSINH, DCHI, GIOITINH, MALOP) VALUES
(N'SV001', N'Nguyen Van A', '1999-01-01', N'Quan 1, TP.HCM', N'Nam', N'24THTH2'),
(N'SV002', N'Tran Thi B', '1998-02-15', N'Quan 7, TP.HCM', N'Nữ', N'24THTH2'),
(N'SV003', N'Le Van C', '2000-05-20', N'Quan 10, TP.HCM', N'Nam', N'25KT1'),
(N'SV004', N'Pham Thi D', '1999-03-10', N'Quan Binh Thanh, TP.HCM', N'Nữ', N'25KT1'),
(N'SV005', N'Hoang Van E', '1998-12-05', N'Quan Tan Binh, TP.HCM', N'Nam', N'26NN1');

-- Thêm dữ liệu vào bảng MONHOC
INSERT INTO MONHOC (MAMH, TENMH, SOTIET) VALUES
(N'MH001', N'Toan cao cap', 45),
(N'MH002', N'Lap trinh Java', 60),
(N'MH003', N'Ngon ngu Anh', 30);

-- Thêm dữ liệu vào bảng KETQUA
INSERT INTO KETQUA (MASV, MAMH, DIEM) VALUES
(N'SV001', N'MH001', 7.5),
(N'SV001', N'MH002', 8.0),
(N'SV002', N'MH001', 6.5),
(N'SV002', N'MH002', 7.0),
(N'SV003', N'MH003', 9.0),
(N'SV004', N'MH003', 8.5);

--Truy Vấn

SELECT HOTEN
FROM SINHVIEN
JOIN KETQUA ON SINHVIEN.MASV = KETQUA.MASV
JOIN LOP ON SINHVIEN.MALOP = LOP.MALOP
WHERE LOP.TENLOP = '24THTH2' AND KETQUA.DIEM BETWEEN 6 AND 8;

SELECT TENKHOA, COUNT(MALOP) AS SoLuongLop
FROM KHOA
LEFT JOIN LOP ON KHOA.MAKHOA = LOP.MAKHOA
GROUP BY TENKHOA;

WITH DiemTrungBinh AS (
    SELECT MASV, AVG(DIEM) AS DiemTrungBinh
    FROM KETQUA
    GROUP BY MASV
)
SELECT SINHVIEN.MASV, HOTEN, DiemTrungBinh
FROM SINHVIEN
JOIN DiemTrungBinh ON SINHVIEN.MASV = DiemTrungBinh.MASV;

SELECT HOTEN
FROM SINHVIEN
WHERE MASV IN (SELECT MASV FROM KETQUA GROUP BY MASV HAVING COUNT(MAMH) > 2);

WITH DiemTrungBinh AS (
    SELECT MASV, AVG(DIEM) AS DiemTrungBinh
    FROM KETQUA
    GROUP BY MASV
)
SELECT TOP 1 HOTEN
FROM SINHVIEN
JOIN DiemTrungBinh ON SINHVIEN.MASV = DiemTrungBinh.MASV
WHERE GIOITINH = N'Nữ'
ORDER BY DiemTrungBinh DESC;

SELECT TENKHOA
FROM KHOA
WHERE MAKHOA IN (SELECT MAKHOA FROM LOP GROUP BY MAKHOA HAVING COUNT(MALOP) >= 3);

SELECT TOP 1 HOTEN
FROM SINHVIEN
ORDER BY (SELECT COUNT(*) FROM KETQUA WHERE KETQUA.MASV = SINHVIEN.MASV) DESC;

SELECT TENMH
FROM MONHOC
WHERE MAMH NOT IN (SELECT MAMH FROM KETQUA);

SELECT HOTEN
FROM SINHVIEN
WHERE MASV NOT IN (SELECT MASV FROM KETQUA WHERE MAMH = 'CO SO DU LIEU');

SELECT TENLOP
FROM LOP
WHERE SISODK > (SELECT COUNT(*) FROM SINHVIEN WHERE SINHVIEN.MALOP = LOP.MALOP);
